---
import "../../styles/global.css";
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Iniciar sesión – Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body class="min-h-screen grid place-items-center bg-[var(--surface)] text-[var(--text)]">
    <form id="loginForm"
          action="#"
          method="post"
          class="w-full max-w-sm bg-[var(--card)] border border-[var(--card-border)] rounded-xl p-6 space-y-4"
          onsubmit="return __login(event)">
      <h1 class="text-xl font-bold">Iniciar sesión</h1>

      <div>
        <label class="text-sm">Email</label>
        <input name="email" type="email" required
               class="mt-1 w-full rounded-lg border border-[var(--card-border)] px-3 py-2 bg-white" />
      </div>

      <div>
        <label class="text-sm">Contraseña</label>
        <input name="pass" type="password" required
               class="mt-1 w-full rounded-lg border border-[var(--card-border)] px-3 py-2 bg-white" />
      </div>

      <button type="submit" class="btn w-full">Entrar</button>
      <p class="text-xs text-[var(--muted)]">Demo: buleria.games@gmail.com / owner123</p>
    </form>

    <!-- Cargar helper primero -->
    <script src="/admin-auth.js?v=7" is:inline defer></script>

    <script>
      // @ts-nocheck
      window.__login = async function (ev) {
        ev.preventDefault(); // <-- evita el GET con ?email=...&pass=...
        try {
          const form  = document.getElementById('loginForm');
          const email = form.email.value.trim();
          const pass  = form.pass.value.trim();
          await tpAdminAuth.login(email, pass); // guarda token
          location.href = '/admin';
          return false;
        } catch (e) {
          alert(e?.message || 'No se pudo iniciar sesión');
          return false;
        }
      };

      document.addEventListener('DOMContentLoaded', async () => {
        // si ya hay token válido, pasá directo
        try {
          if (window.tpAdminAuth?.isLogged() && (await tpAdminAuth.me())) {
            location.href = '/admin';
          }
        } catch {}
      });
    </script>
  </body>
</html>
