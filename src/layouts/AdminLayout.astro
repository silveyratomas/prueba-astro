---
import "../styles/global.css";
const { title = "Admin – TuTienda" } = Astro.props;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body class="min-h-screen bg-[var(--surface)] text-[var(--text)]">
    <!-- Header admin (sticky, sobrio y profesional) -->
    <header
      class="sticky top-0 z-40 border-b border-[var(--card-border)] bg-[var(--card)]/95 backdrop-blur-sm"
    >
      <div class="container flex items-center justify-between gap-4 py-3">
        <div class="flex items-center gap-4">
          <div
            class="w-10 h-10 rounded-lg bg-[var(--brand)] flex items-center justify-center text-white font-bold"
          >
            TP
          </div>
          <div>
            <p class="text-xs text-[var(--muted)]">Panel de Administración</p>
            <h1 class="text-base font-semibold">{title}</h1>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <a href="/" class="text-sm text-[var(--muted)] hover:underline"
            >Ver tienda</a
          >
          <div class="h-6 border-l border-[var(--card-border)]"></div>
          <button
            id="btnLogout"
            type="button"
            class="rounded-md bg-[var(--brand)] text-[var(--on-brand)] px-3 py-1 text-sm hover:brightness-95"
            >Salir</button
          >
        </div>
      </div>
    </header>

    <!-- Subbarra: navegación horizontal (fija debajo del header) -->
    <div class="sticky top-14 z-30">
      <div
        class="container bg-[var(--card)] border-b border-[var(--card-border)] rounded-b-2xl"
      >
        <nav id="adminNav" class="flex gap-4 items-center px-4 py-3 text-sm">
          <a
            href="/admin"
            class="rounded-md px-3 py-2 hover:bg-[var(--surface)] flex items-center gap-2"
          >
            <span class="text-[var(--muted)]">🏠</span>
            <span>General</span>
          </a>
          <a
            href="/admin/productos"
            class="rounded-md px-3 py-2 hover:bg-[var(--surface)] flex items-center gap-2"
          >
            <span class="text-[var(--muted)]">📦</span>
            <span>Productos</span>
          </a>
          <!-- más items aquí -->
        </nav>
      </div>
    </div>

    <!-- Contenido principal: una sola columna, el nav ya está arriba -->
    <div class="container py-10">
      <main class="min-h-[60vh] bg-transparent">
        <slot />
      </main>
    </div>

    <!-- helper de auth primero -->
    <script src="/admin-auth.js?v=7" is:inline defer></script>
    <!-- opcional: tu lógica general de panel -->
    <script src="/admin.js?v=7" is:inline defer></script>
    <!-- admin: categorías (gestión desde el panel) -->
    <script src="/admin-categories.js" defer></script>
    <!-- ⚠️ SUGERENCIA: quitar admin-products.js para evitar conflictos con la vista nueva -->
    <!-- <script src="/admin-products.js?v=1" is:inline defer></script> -->

    <script>
      // @ts-nocheck
      document.addEventListener("DOMContentLoaded", async () => {
        // Proteger todas las vistas del admin
        try {
          if (window.tpAdmin?.requireSessionOrRedirect) {
            const ok = await tpAdmin.requireSessionOrRedirect();
            if (!ok) return;
          }
        } catch (e) {
          console.warn("[admin] guard error:", e);
        }

        // Logout
        document.getElementById("btnLogout")?.addEventListener("click", () => {
          try {
            window.tpAdminAuth?.logout?.();
          } finally {
            location.href = "/admin/login";
          }
        });

        // Sidebar activo
        const nav = document.getElementById("adminNav");
        if (nav) {
          const links = Array.from(nav.querySelectorAll("a[href]"));
          const here = location.pathname.replace(/\/+$/, "");
          links.forEach((a) => {
            const href = (a.getAttribute("href") || "").replace(/\/+$/, "");
            if (
              href &&
              (here === href || (href !== "/" && here.startsWith(href)))
            ) {
              a.classList.add("bg-[var(--surface)]", "font-medium");
              a.setAttribute("aria-current", "page");
            }
          });
        }
      });
    </script>
  </body>
</html>
